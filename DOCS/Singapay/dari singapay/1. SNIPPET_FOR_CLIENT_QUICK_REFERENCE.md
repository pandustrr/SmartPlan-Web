# Payment Gateway API - Quick Reference Card

## ðŸ“‹ System Requirements

### Minimum Requirements
- **PHP**: >= 8.1
- **Laravel**: >= 9.x
- **Extensions**:
  - `ext-json`
  - `ext-openssl`
  - `ext-curl`
  - `ext-mbstring`

### Recommended
- **PHP**: 8.2 or higher
- **Laravel**: 10.x or 11.x
- **Cache Driver**: Redis or Memcached (for production)
- **Memory Limit**: 256M minimum
- **Max Execution Time**: 60 seconds minimum

### Laravel Packages (Already Included)
- `guzzlehttp/guzzle`: ^7.2 (for HTTP client)
- `laravel/framework`: ^9.0|^10.0|^11.0

### Server Requirements
- **SSL Certificate**: Required (HTTPS only)
- **IP Whitelisting**: Your server IP must be whitelisted
- **Firewall**: Allow outbound HTTPS (port 443) to Payment Gateway
- **Network**: Stable internet connection for API calls

## ðŸ”§ Installation Steps

### 1. Copy Helper File
```bash
# Copy MerchantApiHelper.php.txt to app/Helpers/MerchantApiHelper.php
cp MerchantApiHelper.php.txt app/Helpers/MerchantApiHelper.php
```

### 2. Configure Cache Driver (Production)
Edit `config/cache.php`:
```php
'default' => env('CACHE_DRIVER', 'redis'),
```

Add to `.env`:
```env
CACHE_DRIVER=redis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

### 3. Request IP Whitelisting
Contact Payment Gateway admin to whitelist your server IP:
```bash
# Get your server public IP
curl ifconfig.me
```

## ðŸ”‘ Environment Setup

```env
# Required
PG_BASE_URL=https://your-payment-gateway.com
PG_CLIENT_KEY=your_client_key
PG_CLIENT_SECRET=your_client_secret
PG_API_KEY=your_api_key

# Recommended
CACHE_DRIVER=redis
LOG_CHANNEL=daily
LOG_LEVEL=debug
```

## âœ… Verification After Installation

### Test 1: Check Helper is Loaded
```bash
php artisan tinker
```
```php
// Should return class name
get_class(new App\Helpers\MerchantApiHelper);
// Output: "App\Helpers\MerchantApiHelper"
```

### Test 2: Check Environment Variables
```bash
php artisan tinker
```
```php
env('PG_BASE_URL');
env('PG_CLIENT_KEY');
env('PG_CLIENT_SECRET');
// Should not return null
```

### Test 3: Test API Connection
```php
use App\Helpers\MerchantApiHelper;

try {
    $response = MerchantApiHelper::sendRequest('/api/v1.0/accounts', [], 'GET');

    if ($response->successful()) {
        echo "âœ… Connection Success!";
        var_dump($response->json());
    } else {
        echo "âŒ Error: " . $response->status();
        var_dump($response->json());
    }
} catch (\Exception $e) {
    echo "âŒ Exception: " . $e->getMessage();
}
```

### Test 4: Check Cache is Working
```bash
php artisan tinker
```
```php
use Illuminate\Support\Facades\Cache;

// Test cache
Cache::put('test_key', 'test_value', 60);
echo Cache::get('test_key'); // Should output: test_value
Cache::forget('test_key');
```

## ðŸ“ž Basic Usage

```php
use App\Helpers\MerchantApiHelper;

// GET
$response = MerchantApiHelper::sendRequest('/api/v1.0/accounts', [], 'GET');

// POST
$response = MerchantApiHelper::sendRequest('/api/v1.0/endpoint', $data, 'POST');

// Check status
if ($response->successful()) {
    $data = $response->json()['data'];
}
```

## ðŸ” Inquiry Status (NEW!)

```php
// Format: inquiryStatus($type, $accountId, $transactionId)

// VA
MerchantApiHelper::inquiryStatus('va', $accountId, $transactionId);

// Payment Link
MerchantApiHelper::inquiryStatus('payment-link', $accountId, $historyId);

// QRIS
MerchantApiHelper::inquiryStatus('qris', $accountId, $qrisId);

// Disbursement
MerchantApiHelper::inquiryStatus('disbursement', $accountId, $transactionId);

// Bulk Disbursement
MerchantApiHelper::inquiryStatus('bulk-disbursement', $accountId, $transactionId);

// Cardless Withdrawal
MerchantApiHelper::inquiryStatus('clwd', $accountId, $withdrawalId);
```

## ðŸ’° Balance & Account

```php
// Merchant balance
MerchantApiHelper::sendRequest('/api/v1.0/balance-inquiry', [], 'GET');

// Account balance
MerchantApiHelper::sendRequest("/api/v1.0/balance-inquiry/{$accountId}", [], 'GET');

// List accounts
MerchantApiHelper::sendRequest('/api/v1.0/accounts', [], 'GET');
```

## ðŸ¦ Virtual Account

```php
// Create VA
MerchantApiHelper::sendRequest("/api/v1.0/virtual-accounts/{$accountId}", [
    'bank_code' => 'BRI',
    'amount' => 100000,
    'kind' => 'temporary',
    'expired_at' => now()->addDays(7)->timestamp * 1000,
    'max_usage' => 1,
], 'POST');

// List VA transactions
MerchantApiHelper::sendRequest("/api/v1.0/va-transactions/{$accountId}", [], 'GET');

// Inquiry VA status â­NEW
MerchantApiHelper::inquiryStatus('va', $accountId, $transactionId);
```

## ðŸ”— Payment Link

```php
// Create Payment Link
MerchantApiHelper::sendRequest("/api/v1.0/payment-link-manage/{$accountId}", [
    'reff_no' => 'INV001',
    'title' => 'Invoice Payment',
    'total_amount' => 150000,
    'max_usage' => 1,
    'items' => [
        ['name' => 'Product A', 'quantity' => 1, 'unit_price' => 150000]
    ],
], 'POST');

// List histories
MerchantApiHelper::sendRequest("/api/v1.0/payment-link-histories/{$accountId}", [], 'GET');

// Inquiry status â­NEW
MerchantApiHelper::inquiryStatus('payment-link', $accountId, $historyId);
```

## ðŸ“± QRIS

```php
// Generate QRIS
MerchantApiHelper::sendRequest("/api/v1.0/qris-dynamic/{$accountId}/generate-qr", [
    'amount' => 50000,
    'expired_at' => '2024-12-31 23:59:59',
], 'POST');

// List QRIS
MerchantApiHelper::sendRequest("/api/v1.0/qris-dynamic/{$accountId}", [], 'GET');

// Inquiry QRIS status â­NEW
MerchantApiHelper::inquiryStatus('qris', $accountId, $qrisId);
```

## ðŸ’¸ Disbursement

```php
// Check beneficiary
MerchantApiHelper::sendRequest('/api/v1.0/disbursement/check-beneficiary', [
    'to_bank_code' => '014',
    'beneficiary_account_no' => '1234567890',
], 'POST');

// Create disbursement
MerchantApiHelper::sendRequest("/api/v1.0/disbursement/{$accountId}/transfer", [
    'to_bank_code' => '014',
    'beneficiary_account_no' => '1234567890',
    'amount' => 100000,
    'notes' => 'Payment for invoice',
], 'POST');

// Inquiry disbursement status â­NEW
MerchantApiHelper::inquiryStatus('disbursement', $accountId, $transactionId);

// Inquiry bulk disbursement status â­NEW
MerchantApiHelper::inquiryStatus('bulk-disbursement', $accountId, $transactionId);
```

## ðŸ§ Cardless Withdrawal

```php
// Create CLWD
MerchantApiHelper::sendRequest("/api/v1.0/cardless-withdrawals/{$accountId}", [
    'payment_vendor_id' => 1,
    'amount' => 100000,
    'customer_phone' => '08123456789',
], 'POST');

// List CLWD
MerchantApiHelper::sendRequest("/api/v1.0/cardless-withdrawals/{$accountId}", [], 'GET');

// Inquiry CLWD status â­NEW
MerchantApiHelper::inquiryStatus('clwd', $accountId, $withdrawalId);
```

## âŒ Error Handling

```php
$response = MerchantApiHelper::sendRequest($endpoint, $data, $method);

if ($response->failed()) {
    // Return error view
    return MerchantApiHelper::handleApiError($response);

    // Or custom handling
    return back()->withErrors([
        'error' => $response->json()['message'] ?? 'API Error'
    ]);
}

// Success
$data = $response->json()['data'];
```

## ðŸ”„ Token Management

```php
// Clear token cache (force regenerate)
MerchantApiHelper::clearToken();

// Token will auto-refresh on next request
```

## ðŸ› Debug Mode

```env
# Enable detailed logging
APP_DEBUG=true
```

```php
// Check logs at storage/logs/laravel.log
tail -f storage/logs/laravel.log | grep "PG"
```

## ðŸ“Š HTTP Status Codes

| Code | Meaning |
|------|---------|
| 200 | Success |
| 401 | Unauthorized (Invalid token) |
| 403 | Forbidden (IP not whitelisted) |
| 404 | Not Found |
| 422 | Validation Error |
| 500 | Server Error |

## ðŸŽ¯ Transaction ID Formats

| Type | Format | Example |
|------|--------|---------|
| VA | `VA{date}{sequence}` | `VA240513162304123456` |
| Disbursement | `DSB{date}{sequence}` | `DSB240513162304123456` |
| Bulk Disbursement | `BDISB{date}{sequence}` | `BDISB240513162304123456` |
| QRIS | Integer ID | `123` |
| Payment Link | Integer ID | `456` |
| CLWD | Integer ID | `789` |

## ðŸš¨ Troubleshooting

### 401 Error (Unauthorized)
```php
// Clear token and retry
MerchantApiHelper::clearToken();
$response = MerchantApiHelper::sendRequest($endpoint, $data, $method);
```

**Common Causes:**
- Invalid `PG_CLIENT_KEY` or `PG_CLIENT_SECRET`
- Token expired (should auto-refresh, but cache might be corrupted)
- Wrong signature generation

### 403 Error (Forbidden)
**Common Causes:**
- Server IP not whitelisted
- Request from localhost/development environment

**Solution:**
```bash
# 1. Get your server IP
curl ifconfig.me

# 2. Contact PG admin to whitelist IP
# 3. For development, ask for VPN access or use staging environment
```

### 404 Error (Not Found)
**Common Causes:**
- Wrong endpoint URL
- Invalid `account_id` or `transaction_id`
- Resource doesn't exist or was deleted

**Solution:**
- Double-check endpoint path
- Verify IDs are correct
- Check if resource exists in database

### 422 Error (Validation Error)
```php
$response = MerchantApiHelper::sendRequest($endpoint, $data, $method);

if ($response->status() === 422) {
    $errors = $response->json()['errors'];
    foreach ($errors as $field => $messages) {
        echo "$field: " . implode(', ', $messages);
    }
}
```

### Token Not Cached
```bash
# Check cache driver (don't use 'array' in production)
php artisan config:clear
php artisan cache:clear

# Check Redis connection (if using Redis)
php artisan tinker
>>> Cache::getStore()->getDriver()
>>> Redis::ping()
```

### Connection Timeout
**Common Causes:**
- Slow network connection
- PG API server is down
- Firewall blocking outbound HTTPS

**Solution:**
```bash
# Test connectivity
curl -v https://your-payment-gateway.com

# Check firewall
sudo ufw status
```

### SSL Certificate Error
**Common Causes:**
- Outdated CA certificates
- Server doesn't support required SSL/TLS version

**Solution:**
```bash
# Update CA certificates (Ubuntu/Debian)
sudo apt-get update
sudo apt-get install ca-certificates

# Update CA certificates (CentOS/RHEL)
sudo yum update ca-certificates
```

## ðŸ’¡ Best Practices

### 1. Always Use Try-Catch
```php
try {
    $response = MerchantApiHelper::sendRequest($endpoint, $data, $method);
    // Process response
} catch (\Exception $e) {
    Log::error('PG API Error: ' . $e->getMessage());
    return back()->with('error', 'System error, please try again');
}
```

### 2. Implement Retry Logic for Critical Operations
```php
$maxRetries = 3;
$retryCount = 0;
$response = null;

while ($retryCount < $maxRetries) {
    try {
        $response = MerchantApiHelper::sendRequest($endpoint, $data, $method);

        if ($response->successful()) {
            break;
        }

        if ($response->status() === 401) {
            MerchantApiHelper::clearToken();
        }

        $retryCount++;
        sleep(1); // Wait 1 second before retry

    } catch (\Exception $e) {
        $retryCount++;
        if ($retryCount >= $maxRetries) {
            throw $e;
        }
    }
}
```

### 3. Use Queue for Non-Critical Operations
```php
// Instead of synchronous API call
dispatch(new ProcessDisbursementJob($accountId, $data));

// In ProcessDisbursementJob.php
public function handle()
{
    $response = MerchantApiHelper::sendRequest(
        "/api/v1.0/disbursement/{$this->accountId}/transfer",
        $this->data,
        'POST'
    );

    // Handle response
}
```

### 4. Implement Proper Logging
```php
use Illuminate\Support\Facades\Log;

// Log before API call
Log::info('PG API Request', [
    'endpoint' => $endpoint,
    'method' => $method,
    'data' => $data,
]);

$response = MerchantApiHelper::sendRequest($endpoint, $data, $method);

// Log after API call
Log::info('PG API Response', [
    'status' => $response->status(),
    'body' => $response->json(),
]);
```

### 5. Use Transaction for Database Operations
```php
use Illuminate\Support\Facades\DB;

DB::beginTransaction();

try {
    // Update local database
    $order->update(['status' => 'processing']);

    // Call PG API
    $response = MerchantApiHelper::sendRequest($endpoint, $data, 'POST');

    if ($response->failed()) {
        throw new \Exception('API failed: ' . $response->body());
    }

    // Update with API response
    $order->update([
        'pg_transaction_id' => $response->json()['data']['transaction_id'],
        'status' => 'success',
    ]);

    DB::commit();

} catch (\Exception $e) {
    DB::rollBack();
    Log::error('Transaction failed: ' . $e->getMessage());
    throw $e;
}
```

### 6. Validate Data Before API Call
```php
$validated = $request->validate([
    'account_id' => 'required|string',
    'amount' => 'required|numeric|min:10000|max:100000000',
    // ... other validations
]);

// Only call API after validation passes
$response = MerchantApiHelper::sendRequest($endpoint, $validated, 'POST');
```

### 7. Use Inquiry Status for Real-Time Updates
```javascript
// Frontend: Poll status every 5 seconds
setInterval(async () => {
    const response = await fetch(`/check-status/${transactionId}`);
    const data = await response.json();

    if (data.status === 'paid') {
        // Stop polling
        clearInterval(this);
        // Update UI
        showSuccessMessage();
    }
}, 5000);
```

```php
// Backend: Check status endpoint
public function checkStatus($transactionId)
{
    $response = MerchantApiHelper::inquiryStatus(
        'va',
        auth()->user()->pg_account_id,
        $transactionId
    );

    return response()->json($response->json()['data']);
}
```

## ðŸ“Š Performance Tips

### 1. Use Redis for Cache (Production)
```env
CACHE_DRIVER=redis
REDIS_CLIENT=phpredis  # Faster than predis
```

### 2. Enable OPcache
```ini
; php.ini
opcache.enable=1
opcache.memory_consumption=256
opcache.max_accelerated_files=20000
```

### 3. Use HTTP/2 (if supported)
- Ensure your server supports HTTP/2
- PG API supports HTTP/2 for better performance

### 4. Implement Response Caching for GET Requests
```php
use Illuminate\Support\Facades\Cache;

$cacheKey = "pg_accounts_{$merchantId}";

$accounts = Cache::remember($cacheKey, 300, function () {
    $response = MerchantApiHelper::sendRequest('/api/v1.0/accounts', [], 'GET');
    return $response->json()['data'];
});
```

## ðŸ“ž Support

- **Email**: support@paymentgateway.com
- **Docs**: https://docs.paymentgateway.com
- **Status Page**: https://status.paymentgateway.com
- **Emergency**: +62-xxx-xxxx-xxxx (24/7)

## ðŸ“š Additional Resources

- [Complete API Documentation](./SNIPPET_FOR_CLIENT_API_ENDPOINTS.md)
- [Usage Examples](./SNIPPET_FOR_CLIENT_USAGE_EXAMPLES.md)
- [Test Controller](./SNIPPET_FOR_CLIENT_TestController.php)
- [Main README](./SNIPPET_FOR_CLIENT_README.md)

---

**Print this card for quick reference!** ðŸ“„

*Last updated: 2025-01-15*
